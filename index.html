<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Rentas Cordero</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --negro: #1a1a1a; --verde: #27ae60; --amarillo: #f1c40f; --rojo: #e74c3c; 
            --mantenimiento: #f39c12; --gris: #f4f4f4; --texto: #333; --azul: #2980b9;
        }
        body { font-family: 'Segoe UI', Helvetica, Arial, sans-serif; background-color: #ffffff; margin: 20px; color: var(--texto); line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; }
        
        /* HEADER FIJO Y ESTABLE */
        .header-logo { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-wrap: wrap; height: 100px; overflow: hidden; }
        .header-logo img { height: 80px; width: auto; border-radius: 50%; object-fit: contain; }
        h1 { font-weight: 300; font-size: 2rem; margin: 0; }
        
        .subtitulo { font-size: 1.1rem; font-weight: 600; color: #888; text-transform: uppercase; margin-top: 40px; margin-bottom: 20px; }

        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .lavadora-card { padding: 15px; border: 1px solid #eee; border-radius: 4px; text-align: center; position: relative; }
        .lav-libre { border-left: 6px solid var(--verde); }
        .lav-ocupada { border-left: 6px solid var(--rojo); background: #fafafa; }
        .lav-mante { border-left: 6px solid var(--mantenimiento); background: #fffcf0; }
        
        .btn-mante { margin-top: 10px; font-size: 11px; cursor: pointer; background: none; border: 1px solid #ddd; padding: 4px 8px; }
        
        .btn-del-item { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #ccc; cursor: pointer; font-size: 16px; font-weight: bold; transition: color 0.2s; }
        .btn-del-item:hover { color: var(--rojo); }

        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, button { padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        .ac-wrapper { position: relative; }
        .ac-dropdown { position: absolute; background: white; border: 1px solid #ddd; width: 100%; z-index: 100; max-height: 150px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .ac-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f9f9f9; font-size: 14px; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 800px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #666; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        
        .status-box { padding: 4px 8px; border-radius: 3px; color: white; font-weight: bold; font-size: 11px; display: inline-block; margin-bottom: 2px; }
        .bg-negro { background: var(--negro); }
        .bg-amarillo { background: var(--amarillo); color: black; }
        .bg-rojo { background: var(--rojo); }
        .bg-verde { background: var(--verde); }
        .bg-azul { background: var(--azul); }

        #modalFirma { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; padding: 10px; overflow-y: auto; }
        
        canvas { border: 2px solid #000; background: #fff; touch-action: none; cursor: crosshair; max-width: 100%; height: auto; }

        .btn-negro { background: var(--negro); color: white; cursor: pointer; border: none; }
        .btn-pdf { background: var(--verde); color: white; border: none; cursor: pointer; padding: 10px; }
        .btn-pago { background: #8e44ad; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; }
        .btn-aplazar { background: var(--amarillo); color: black; border: none; padding: 5px 10px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-rerentar { background: var(--azul); color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .maps-link { color: var(--azul); text-decoration: none; font-weight: bold; font-size: 12px; }
        
        .btn-del-tabla { background: none; border: none; color: #ddd; cursor: pointer; font-weight: bold; padding: 5px; }
        .btn-del-tabla:hover { color: var(--rojo); }
    </style>
</head>
<body>

<div class="container">
    <div class="header-logo">
        <img src="logo.png" alt="RC" onerror="this.style.display='none';">
        <h1>Rentas Cordero <small style="font-size: 10px; color: var(--verde);">‚óè ONLINE</small></h1>
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <button class="btn-pdf" onclick="descargarPDF()">Reporte General PDF</button>
            <button class="btn-negro" onclick="borrarHistorial()" style="background: #c0392b; color: white; font-size: 10px;">üóë Eliminar Historial</button>
        </div>
    </div>

    <div class="subtitulo">Inventario de Equipos</div>
    <div class="grid-inputs" style="margin-bottom: 20px;">
        <input type="text" id="inv_num" placeholder="N√∫mero de Lavadora">
        <input type="text" id="inv_mod" placeholder="Marca / Modelo">
        <button class="btn-negro" onclick="sumarLavadora()">Registrar Equipo</button>
    </div>
    <div id="grid-inv" class="inv-grid"></div>

    <div class="subtitulo">Registro de Cliente</div>
    <div class="grid-inputs" id="form-registro">
        <div class="ac-wrapper">
            <input type="text" id="nombre" placeholder="Nombre Completo" onkeyup="autoCompleta(this, 'nombre')">
            <div id="sug-nombre" class="ac-dropdown"></div>
        </div>
        <input type="text" id="calle" placeholder="Calle">
        <input type="text" id="num_casa" placeholder="N√∫mero de casa">
        <input type="text" id="colonia" placeholder="Colonia">
        <input type="text" id="celular" placeholder="Celular (10 d√≠gitos)" maxlength="10">
        <div style="display: flex; flex-direction: column;">
            <label style="font-size: 12px; color: #666;">Fecha de recogida:</label>
            <input type="date" id="fecha_recogida" lang="es-MX">
        </div>
        <select id="select_lav"></select>
        <button class="btn-negro" onclick="crearPedido()">Registrar Entrega</button>
    </div>

    <div class="subtitulo">Listado de Servicios</div>
    <input type="text" id="buscador" placeholder="üîç Buscar cliente, folio o direcci√≥n..." onkeyup="renderTablas(this.value)" style="width: 100%; margin-bottom: 20px; padding: 12px; border: 1px solid #ddd;">
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Folio / Cliente / Ubicaci√≥n</th>
                    <th>Lavadora</th>
                    <th>Estado de Renta</th>
                    <th>Estado de Pago</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-body"></tbody>
        </table>
    </div>

</div>

<div id="modalFirma">
    <h2 style="margin-top:0; text-align:center;">Confirmaci√≥n de Entrega</h2>
    
    <div style="background: #fff8e1; border: 1px solid #ffe082; padding: 15px; border-radius: 8px; margin-bottom: 15px; width: 100%; max-width: 450px; font-size: 13px;">
        <b style="color: #f57c00; display: block; margin-bottom: 5px;">RESUMEN DE CL√ÅUSULAS:</b>
        Entrega obligatoria en domicilio registrado, devoluci√≥n en √≥ptimas condiciones, puntualidad en horario de recogida para evitar cargos extra y aviso previo para renovaci√≥n o entrega anticipada.
    </div>

    <div style="margin-bottom: 15px; text-align: center; background: #f4f4f4; padding: 15px; border-radius: 8px; width: 100%; max-width: 450px;">
        <label style="font-weight: bold; color: var(--rojo); display: block; margin-bottom: 10px;">üì∑ FOTO DE INE / COMPROBANTE (OBLIGATORIO):</label>
        <input type="file" id="fotoDocs" accept="image/*" style="font-size: 13px;">
        <hr>
        <label style="font-size: 16px; cursor: pointer; background: #fff; padding: 10px; display: block; border: 1px solid #ddd;">
            <input type="checkbox" id="checkPagoModal"> <b>¬øEL CLIENTE YA PAG√ì?</b>
        </label>
    </div>
    <canvas id="canvasFirma" width="450" height="200"></canvas>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button onclick="cerrarFirma()" style="padding: 10px 20px;">Cancelar</button>
        <button onclick="limpiarFirma()" style="padding: 10px 20px;">Limpiar</button>
        <button class="btn-negro" onclick="confirmarEntrega()" style="padding: 10px 40px;">CONFIRMAR ENTREGA</button>
    </div>
</div>

<script type="module">
    // Importamos las funciones necesarias de Firebase (Usamos versi√≥n estable 10.7.0)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    // Tu configuraci√≥n exacta
    const firebaseConfig = {
        apiKey: "AIzaSyAstKJ4ZHnhS2SEIzMyUu_DK3DfEKdXW8s",
        authDomain: "rentas-cordero-ced3d.firebaseapp.com",
        projectId: "rentas-cordero-ced3d",
        storageBucket: "rentas-cordero-ced3d.firebasestorage.app",
        messagingSenderId: "266758467590",
        appId: "1:266758467590:web:37aa7eed21dfa4b24d5387"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales (Sincronizadas con Firebase)
    window.lavadoras = [];
    window.pedidos = [];
    let pedidoIDGlobal = null;
    let renderLock = false;

    // --- CONEXI√ìN EN TIEMPO REAL (LISTENERS) ---
    // Esto reemplaza al localStorage. Al cambiar algo en la nube, se actualiza aqu√≠ solito.
    
    // Escuchar Lavadoras
    onSnapshot(collection(db, "lavadoras"), (snapshot) => {
        window.lavadoras = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        renderInventario();
        cargarSelect();
    }, (error) => console.error("Error cargando lavadoras:", error));

    // Escuchar Pedidos
    onSnapshot(collection(db, "pedidos"), (snapshot) => {
        window.pedidos = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        renderTablas(document.getElementById('buscador').value || '');
        // FIX: Forzamos re-render de inventario cuando llegan los pedidos para pintar los rojos
        renderInventario(); 
        cargarSelect();
    }, (error) => console.error("Error cargando pedidos:", error));


    // --- FUNCIONES DEL SISTEMA (CRUD CON FIREBASE) ---

    // Hacemos las funciones globales (window.xxx) para que el HTML pueda usarlas
    window.sumarLavadora = async () => {
        let n = document.getElementById('inv_num').value;
        let m = document.getElementById('inv_mod').value;
        if(!n) return alert("N√∫mero de lavadora necesario");
        
        try {
            const id = Date.now().toString(); // ID √∫nico basado en tiempo
            await setDoc(doc(db, "lavadoras", id), { 
                num: n, 
                mod: m, 
                mantenimiento: false 
            });
            document.getElementById('inv_num').value = "";
            document.getElementById('inv_mod').value = "";
        } catch(e) {
            console.error(e);
            alert("Error al guardar. Revise su conexi√≥n.");
        }
    };

    window.eliminarLavadora = async (id) => {
        if(confirm("¬øEliminar esta lavadora de la base de datos?")) {
            await deleteDoc(doc(db, "lavadoras", id.toString()));
        }
    };

    window.toggleMantenimiento = async (id) => {
        const l = window.lavadoras.find(x => x.id == id);
        if(l) {
            await updateDoc(doc(db, "lavadoras", id.toString()), { mantenimiento: !l.mantenimiento });
        }
    };

    window.crearPedido = async () => {
        let fRecogida = document.getElementById('fecha_recogida').value;
        if(!fRecogida) return alert("Seleccione fecha de recogida.");
        
        let nom = document.getElementById('nombre').value;
        let lav = document.getElementById('select_lav').value;

        if(!nom || !lav) return alert("Nombre y Lavadora obligatorios");

        const id = Date.now().toString();
        // Generar folio simple basado en los √∫ltimos 4 d√≠gitos del ID temporal
        const folio = "F-" + id.slice(-4); 

        const nuevoPedido = {
            folio: folio,
            nombre: nom,
            calle: document.getElementById('calle').value,
            num_casa: document.getElementById('num_casa').value,
            colonia: document.getElementById('colonia').value,
            cel: document.getElementById('celular').value,
            lav: lav,
            estado: 'negro',
            pagado: false,
            vence: fRecogida, 
            aplazos: 0,
            aplazosPagados: 0,
            fechaRegistro: new Date().toISOString().split('T')[0]
        };

        try {
            await setDoc(doc(db, "pedidos", id), nuevoPedido);
            limpiarForm();
        } catch(e) {
            console.error(e);
            alert("Error al crear pedido. Verifique conexi√≥n.");
        }
    };

    window.eliminarPedido = async (id) => {
        if(confirm("¬øEliminar este registro permanentemente de la nube?")) {
            await deleteDoc(doc(db, "pedidos", id));
        }
    };

    // FUNCION NUEVA: ELIMINAR HISTORIAL (SOLO VERDES)
    window.borrarHistorial = async () => {
        // Filtramos solo los pedidos que ya est√°n "Verdes" (Entregados/Finalizados)
        const finalizados = window.pedidos.filter(p => p.estado === 'verde');
        
        if(finalizados.length === 0) {
            return alert("No hay historial para borrar (no hay rentas finalizadas).");
        }

        if(confirm(`‚ö†Ô∏è ATENCI√ìN:\n\nSe van a eliminar ${finalizados.length} registros del HISTORIAL (Rentas ya finalizadas).\n\nLas rentas activas NO se borrar√°n.\n\n¬øEst√°s seguro?`)) {
            let borrados = 0;
            for (const p of finalizados) {
                try {
                    await deleteDoc(doc(db, "pedidos", p.id));
                    borrados++;
                } catch(e) {
                    console.error("Error borrando pedido antiguo:", e);
                }
            }
            alert(`Historial limpio. Se eliminaron ${borrados} registros antiguos.`);
        }
    };

    window.confirmarEntrega = async () => {
        if(!document.getElementById('fotoDocs').files[0]) return alert("Suba foto de INE.");
        
        try {
            await updateDoc(doc(db, "pedidos", pedidoIDGlobal), {
                estado: 'amarillo',
                pagado: document.getElementById('checkPagoModal').checked
            });
            cerrarFirma();
        } catch(e) { alert("Error al confirmar entrega"); }
    };

    window.pagarRenta = async (id) => {
        await updateDoc(doc(db, "pedidos", id), { pagado: true });
    };

    window.pagarAplazamiento = async (id) => {
        const p = window.pedidos.find(x => x.id === id);
        if(p && p.aplazosPagados < p.aplazos) {
            await updateDoc(doc(db, "pedidos", id), { aplazosPagados: p.aplazosPagados + 1 });
        }
    };

    window.aplazar = async (id) => {
        let p = window.pedidos.find(x => x.id === id);
        let dias = prompt("D√≠as extra:", "1");
        if(dias) {
            let nv = new Date(p.vence);
            nv.setDate(nv.getDate() + parseInt(dias)); // En l√≥gica de nube simplificamos +1 dia por zona horaria a c√°lculo directo
            await updateDoc(doc(db, "pedidos", id), {
                vence: nv.toISOString().split('T')[0],
                aplazos: p.aplazos + 1
            });
        }
    };

    window.finalizar = async (id) => {
        let p = window.pedidos.find(x => x.id === id);
        if(!p.pagado || p.aplazosPagados < p.aplazos) return alert("‚õî NO SE PUEDE FINALIZAR: Tiene pagos pendientes.");
        if(confirm("¬øLavadora recogida?")) {
            await updateDoc(doc(db, "pedidos", id), { estado: 'verde' });
        }
    };

    // Funciones de UI Auxiliares (No tocan DB directamente)
    window.reRentar = (id) => {
        let p = window.pedidos.find(x => x.id === id);
        document.getElementById('nombre').value = p.nombre;
        document.getElementById('calle').value = p.calle;
        document.getElementById('num_casa').value = p.num_casa;
        document.getElementById('colonia').value = p.colonia;
        document.getElementById('celular').value = p.cel;
        document.getElementById('select_lav').value = "";
        document.getElementById('fecha_recogida').value = "";
        document.getElementById('form-registro').scrollIntoView({behavior: "smooth"});
    };

    window.abrirFirma = (id) => {
        pedidoIDGlobal = id;
        document.getElementById('modalFirma').style.display = 'flex';
        document.getElementById('fotoDocs').value = "";
        document.getElementById('checkPagoModal').checked = false;
        limpiarFirma();
    };

    window.cerrarFirma = () => document.getElementById('modalFirma').style.display = 'none';

    // --- RENDERIZADO (UI) ---
    // Estas funciones ahora leen window.lavadoras y window.pedidos que Firebase mantiene llenos

    window.renderInventario = () => {
        let g = document.getElementById('grid-inv');
        if (!g) return;
        g.innerHTML = '';
        window.lavadoras.forEach(l => {
            let ocupada = window.pedidos.find(p => p.lav === l.num && p.estado !== 'verde');
            let clase = l.mantenimiento ? 'lav-mante' : (ocupada ? 'lav-ocupada' : 'lav-libre');
            g.innerHTML += `
                <div class="lavadora-card ${clase}">
                    <button class="btn-del-item" onclick="eliminarLavadora('${l.id}')">√ó</button>
                    <b>#${l.num}</b><br><small>${l.mod}</small><br>
                    ${!ocupada ? `<button class="btn-mante" onclick="toggleMantenimiento('${l.id}')">MANT.</button>` : ''}
                </div>`;
        });
        // Renderizamos tablas poco despu√©s para asegurar consistencia
        setTimeout(() => window.renderTablas(document.getElementById('buscador').value || ''), 50);
    };

    window.cargarSelect = () => {
        let s = document.getElementById('select_lav');
        if (!s) return;
        s.innerHTML = '<option value="">Seleccionar Lavadora</option>';
        window.lavadoras.forEach(l => {
            let ocupada = window.pedidos.find(p => p.lav === l.num && p.estado !== 'verde');
            if(!ocupada && !l.mantenimiento) s.innerHTML += `<option value="${l.num}">${l.num} - ${l.mod}</option>`;
        });
    };

    // Helper para fechas bonitas en espa√±ol
    const fechaEsp = (fechaStr) => {
        if(!fechaStr) return "";
        const [y, m, d] = fechaStr.split('-');
        // Creamos fecha local segura
        const fecha = new Date(y, m - 1, d); 
        return fecha.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    };

    window.renderTablas = (resultadoBusqueda) => {
        let b = document.getElementById('tabla-body');
        if (!b) return;

        let htmlAcumulado = "";
        let hoy = new Date().toISOString().split('T')[0];

        // Clonamos y ordenamos para no afectar el array original
        let listaMostrar = [...window.pedidos].reverse();
        
        listaMostrar.forEach(p => {
            // Manejo seguro de strings para b√∫squeda
            let busquedaStr = (p.nombre + " " + p.calle + " " + p.folio).toLowerCase();
            if(resultadoBusqueda && !busquedaStr.includes(resultadoBusqueda.toLowerCase())) return;
            
            let estRenta = p.estado;
            if(estRenta === 'amarillo' && hoy > p.vence) estRenta = 'rojo';
            let txtRenta = {negro:'Por Entregar', amarillo:'En Uso', rojo:'Recoger', verde:'Finalizado'}[estRenta] || estRenta;
            
            let fullAddr = `${p.calle} ${p.num_casa}, ${p.colonia}, Mazatlan`;
            let mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddr)}`;
            
            let htmlAplazamientos = "";
            for(let i=1; i <= p.aplazos; i++) {
                let colorStatus = i <= p.aplazosPagados ? "bg-verde" : "bg-rojo";
                htmlAplazamientos += `<div class="status-box ${colorStatus}">Pagar aplazamiento #${i}</div><br>`;
            }

            // Usamos fechaEsp() para mostrar fecha bonita
            htmlAcumulado += `
                <tr>
                    <td>
                        <span style="font-size:11px; color:var(--azul); font-weight:bold;">FOLIO: ${p.folio}</span><br>
                        <b>${p.nombre}</b><br><small>${p.calle} #${p.num_casa}</small><br>
                        <a href="${mapsLink}" target="_blank" class="maps-link">üìç Ver en Maps</a>
                    </td>
                    <td><b>#${p.lav}</b></td>
                    <td>
                        <div class="status-box bg-${estRenta}">${txtRenta}</div><br>
                        <small><b>Registro:</b> ${p.fechaRegistro}</small><br>
                        <small><b>Vencimiento:</b> <br>${fechaEsp(p.vence)}</small>
                    </td>
                    <td>
                        <div class="status-box ${p.pagado ? "bg-verde" : "bg-rojo"}">${p.pagado ? "PAGADO" : "PENDIENTE"}</div><br>
                        ${htmlAplazamientos}
                    </td>
                    <td>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            ${p.estado === 'verde' ? `
                                <button class="btn-rerentar" onclick="reRentar('${p.id}')">Re-rentar</button>
                            ` : `
                                <button onclick="generarContrato('${p.id}')" style="font-size:11px; font-weight:bold;">üìÑ Contrato</button>
                                ${p.estado === 'negro' ? `<button class="btn-negro" onclick="abrirFirma('${p.id}')">Entregar</button>` : ''}
                                ${!p.pagado && p.estado !== 'negro' ? `<button class="btn-pago" onclick="pagarRenta('${p.id}')">Pagar Renta</button>` : ''}
                                ${p.aplazos > 0 && p.aplazosPagados < p.aplazos ? `<button class="btn-pago" style="background:#8e44ad" onclick="pagarAplazamiento('${p.id}')">Pago Aplazo</button>` : ''}
                                ${p.estado !== 'negro' ? `<button class="btn-rerentar" onclick="reRentar('${p.id}')">Re-rentar</button>` : ''}
                                ${p.estado !== 'verde' && p.estado !== 'negro' ? `<button class="btn-aplazar" onclick="aplazar('${p.id}')">Aplazar</button>` : ''}
                                ${p.estado !== 'verde' && p.estado !== 'negro' ? `<button onclick="finalizar('${p.id}')" style="background:var(--verde); color:white; border:none; padding:5px;">‚úì Recoger</button>` : ''}
                                <button class="btn-del-tabla" onclick="eliminarPedido('${p.id}')">Eliminar √ó</button>
                            `}
                        </div>
                    </td>
                </tr>`;
        });
        b.innerHTML = htmlAcumulado;
    };

    // --- FUNCIONES EXTRA (PDF, Canvas, Autocomplete) ---
    // Estas funciones no requer√≠an cambios grandes, solo usan window.pedidos

    window.generarContrato = (id) => {
        const p = window.pedidos.find(x => x.id === id);
        if(!p) return;
        const l = window.lavadoras.find(lav => lav.num === p.lav) || {mod: "Gen√©rica"};
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // (L√≥gica del PDF original mantenida)
        const fIni = new Date(p.fechaRegistro);
        const fFin = new Date(p.vence);
        const diffTime = Math.abs(fFin - fIni);
        const diasRenta = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 0;

        doc.setFontSize(16);
        doc.text("CONTRATO DE ARRENDAMIENTO - RENTAS CORDERO", 105, 20, {align: 'center'});
        doc.setFontSize(11);
        doc.text("TEL√âFONOS: 6693291400 y 6691081918", 105, 28, {align: 'center'});
        doc.setFontSize(10);
        doc.text(`FOLIO: ${p.folio}`, 15, 40);
        doc.text(`FECHA DEL REGISTRO: ${fechaEsp(p.fechaRegistro)}`, 15, 45);
        doc.text(`TEL√âFONO DEL CLIENTE: ${p.cel}`, 15, 50);
        doc.text(`NOMBRE DE LA PERSONA: ${p.nombre.toUpperCase()}`, 15, 55);
        doc.setFont(undefined, 'bold');
        doc.text("CARTA RESPONSIVA", 15, 65);
        doc.setFont(undefined, 'normal');
        let textoResponsiva = `Rento lavadora por ${diasRenta} d√≠as de la marca ${l.mod} (#${p.lav}) con direcci√≥n en ${p.calle} #${p.num_casa}, Col. ${p.colonia}. Haciendo entrega el d√≠a ${fechaEsp(p.fechaRegistro)} y fecha en la que se recoge el d√≠a ${fechaEsp(p.vence)} en la hora acordada.`;
        let splitResponsiva = doc.splitTextToSize(textoResponsiva, 180);
        doc.text(splitResponsiva, 15, 70);
        
        // Cl√°usulas (reutilizadas)
        doc.setFont(undefined, 'bold');
        doc.text("CL√ÅUSULAS", 15, 90);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        let clausulas = [
            "-ESTOY DE ACUERDO QUE DEBE ENTREGAR DICHA LAVADORA EN EL DOMICILIO ACORDADO ANTERIORMENTE, DE LO CONTRARIO, DEBO PAGAR UNA MULTA DEL PAGO ANTERIOR.",
            "-DICHA LAVADORA LA TENGO QUE ENTREGAR EN LAS MISMAS CONDICIONES COMO SE FUE RENTADA, TENGO EL COMPROMISO DE MANTENERLA ASI, HASTA LA FECHA QUE DEBO ENTREGARLA." ,
            "-ES MI RESPONSABILIDAD DE ENTREGAR DICHA LAVADORA EL DIA Y HORA ESTIMULADA ANTERIORMENTE, SI NO ES ASI, SE ME COBRARA UN COSTO ADICIONAL.",
            "-SI OCUPO ENTREGAR DICHA LAVADORA ANTES DE TIEMPO, ME COMPROMETO EN AVISAR CON UN MINIMO DE 24 HORAS.",
            "-SI ME INTERESA RENOVAR CONTRATO, DEBO AVISAR ANTES DE LA HORA ACORDADA Y PAGAR, SI NO ES ASI ME COMPROMETO A ENTREGARLA."
        ];
        let yPos = 95;
        clausulas.forEach(c => {
            let splitC = doc.splitTextToSize(c, 180);
            doc.text(splitC, 15, yPos);
            yPos += (splitC.length * 5);
        });
        doc.setFontSize(10);
        doc.text("__________________________________________", 105, yPos + 35, {align: 'center'});
        doc.text("FIRMA DEL CLIENTE", 105, yPos + 40, {align: 'center'});
        doc.save(`${p.fechaRegistro} - ${p.nombre} - ${p.folio}.pdf`);
    };

    window.descargarPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); 
        const hoy = new Date().toISOString().split('T')[0];
        doc.setFontSize(16);
        doc.text("REPORTE OPERATIVO - RENTAS CORDERO", 14, 15);
        doc.setFontSize(10);
        doc.text(`Fecha de solicitud del reporte: ${new Date().toLocaleString()}`, 14, 22);
        
        let lista = window.pedidos; // Usamos la lista de la nube

        // 1. PENDIENTES
        doc.setFont(undefined, 'bold'); doc.text("1. PENDIENTES DE ENTREGA", 14, 32);
        const d1 = lista.filter(x => x.estado === 'negro').sort((a,b) => a.folio.localeCompare(b.folio))
                          .map(p => [p.folio, p.nombre, p.cel, p.lav, "PENDIENTE", p.fechaRegistro, p.vence]);
        doc.autoTable({ startY: 35, head: [['Folio', 'Nombre', 'Celular', 'Lavadora', 'Estado', 'Registro', 'Vencimiento']], body: d1 });
        
        // 2. EN USO
        doc.text("2. USUARIOS EN USO", 14, doc.lastAutoTable.finalY + 10);
        const d2 = lista.filter(x => x.estado === 'amarillo' && hoy <= x.vence)
                          .map(p => [p.folio, p.nombre, p.cel, p.lav, "EN USO", p.aplazos, `${p.aplazosPagados}/${p.aplazos}`, p.fechaRegistro, p.vence]);
        doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head: [['Folio', 'Nombre', 'Celular', 'Lavadora', 'Estado', 'Aplazos', 'Pagados', 'Registro', 'Vencimiento']], body: d2 });
        
        // 3. RECOGER
        doc.text("3. LAVADORAS POR RECOGER", 14, doc.lastAutoTable.finalY + 10);
        const d3 = lista.filter(x => (x.estado === 'amarillo' && hoy > x.vence) || x.estado === 'rojo')
                          .map(p => [p.folio, p.nombre, p.cel, p.lav, "RECOGER", p.aplazos, `${p.aplazosPagados}/${p.aplazos}`, p.fechaRegistro, p.vence]);
        doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head: [['Folio', 'Nombre', 'Celular', 'Lavadora', 'Estado', 'Aplazos', 'Pagados', 'Registro', 'Vencimiento']], body: d3 });
        
        // 4. ENTREGADAS
        doc.text("4. LAVADORAS YA RECOGIDAS", 14, doc.lastAutoTable.finalY + 10);
        const d4 = lista.filter(x => x.estado === 'verde')
                          .map(p => [p.folio, p.nombre, p.cel, p.lav, "RECOGIDA", p.aplazos, `${p.aplazosPagados}/${p.aplazos}`, p.fechaRegistro, p.vence]);
        doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head: [['Folio', 'Nombre', 'Celular', 'Lavadora', 'Estado', 'Aplazos', 'Pagados', 'Registro', 'Vencimiento']], body: d4 });
        
        doc.save(`Reporte General Online (${hoy}).pdf`);
    };

    window.autoCompleta = (input, campo) => {
        let val = input.value.toLowerCase();
        let list = document.getElementById('sug-' + campo);
        if(val.length < 2) { list.style.display = 'none'; return; }
        let coinc = window.pedidos.filter(p => p[campo] && p[campo].toLowerCase().includes(val));
        let unicos = [...new Map(coinc.map(i => [i[campo], i])).values()]; // Eliminar duplicados
        if(unicos.length > 0) {
            list.innerHTML = '';
            unicos.forEach(u => {
                let d = document.createElement('div');
                d.className = 'ac-item';
                d.innerText = u[campo] + ` (${u.colonia})`;
                d.onclick = () => {
                    document.getElementById('nombre').value = u.nombre;
                    document.getElementById('calle').value = u.calle;
                    document.getElementById('num_casa').value = u.num_casa;
                    document.getElementById('colonia').value = u.colonia;
                    document.getElementById('celular').value = u.cel;
                    list.style.display = 'none';
                    document.getElementById('nombre').blur();
                };
                list.appendChild(d);
            });
            list.style.display = 'block';
        }
    };

    window.limpiarForm = () => { 
        document.querySelectorAll('#form-registro input:not(#nombre)').forEach(i => i.value = ''); 
        document.getElementById('select_lav').value = "";
        document.getElementById('fecha_recogida').value = "";
    };
    
    window.limpiarFirma = () => { 
        const canvas = document.getElementById('canvasFirma');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,450,200); 
    };

    // Eventos de firma
    const canvas = document.getElementById('canvasFirma');
    const ctx = canvas.getContext('2d');
    let dib = false;
    canvas.addEventListener('mousedown', () => dib = true);
    window.addEventListener('mouseup', () => { dib = false; ctx.beginPath(); });

    // C√ìDIGO COMPLETADO AQU√ç (Faltaba el movimiento del mouse y soporte para celular)
    canvas.addEventListener('mousemove', (e) => {
        if (!dib) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });

    // Soporte para firmar desde Celular
    canvas.addEventListener('touchstart', (e) => {
        dib = true;
        ctx.beginPath();
        e.preventDefault(); 
    }, {passive: false});

    canvas.addEventListener('touchend', () => { dib = false; }, {passive: false});

    canvas.addEventListener('touchmove', (e) => {
        if(!dib) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    }, {passive: false});

</script>
</body>
</html>